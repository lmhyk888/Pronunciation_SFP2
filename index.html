<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>업로드 폼</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --muted:#6b7280;
      --text:#0f172a;
      --active:#f15a29;
      --ring:#f97316;
      --line:#e5e7eb;
      --chip:#f3f4f6;
      --shadow:0 8px 30px rgba(15,23,42,.07);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Apple SD Gothic Neo,Noto Sans KR,sans-serif;color:var(--text);background:linear-gradient(180deg,#f8fafc,#fff 20%)}
    .wrap{max-width:960px;margin:0 auto;padding:20px}

    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
    .p16{padding:16px} .p20{padding:22px}
    h1{font-size:24px;margin:0}
    .muted{color:var(--muted);font-size:14px}

    /* Buttons */
    .btn{appearance:none;border:1px solid var(--line);background:#fff;color:var(--text);padding:10px 16px;border-radius:999px;cursor:pointer;font-size:15px;line-height:1;box-shadow:0 1px 1px rgba(0,0,0,.03)}
    .btn:hover{transform:translateY(-1px)}
    .btn[aria-pressed="true"], .btn.primary{background:var(--active);border-color:var(--active);color:#fff;box-shadow:0 6px 20px rgba(241,90,41,.25)}
    .btn:active{transform:translateY(0)}
    .btn:focus-visible{outline:0;box-shadow:0 0 0 3px rgba(249,115,22,.35)}
    .iconbtn{padding:8px 10px;border-radius:12px;font-size:13px}

    /* Layout */
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:720px){.grid{grid-template-columns:repeat(2,1fr)}}
    .section{margin-top:16px}
    .actions{display:flex;gap:10px;margin-top:14px}
    .submit{background:var(--active);border:0;color:white}

    /* Inputs */
    .field{display:flex;align-items:center;background:#fff;border:1px solid var(--line);border-radius:14px;padding:10px 12px;transition:border-color .2s, box-shadow .2s}
    .field:focus-within{border-color:var(--active);box-shadow:0 0 0 3px rgba(241,90,41,.15)}
    .field label{min-width:64px;color:var(--muted);font-size:14px}
    .field input{flex:1;background:transparent;border:0;outline:0;color:var(--text);font-size:16px}

    /* List */
    .toolbar{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
    .group{margin-top:16px}
    .group h3{margin:0 0 10px;font-size:18px;color:#1f2937}
    .item{display:flex;flex-direction:column;gap:8px;background:#fff;border:1px solid var(--line);border-radius:16px;padding:12px;margin-bottom:10px;transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease}
    .item:hover{transform:translateY(-2px);box-shadow:0 10px 24px rgba(15,23,42,.06)}
    .meta{display:flex;flex-wrap:wrap;gap:6px}
    .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px dashed var(--line);color:#374151;border-radius:999px;padding:6px 10px;font-size:12px}
    .sticky{position:sticky;top:0;z-index:10;background:transparent;backdrop-filter:saturate(140%) blur(6px)}

    /* Collapsible */
    .card-header{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .collapsible{overflow:hidden;transition:max-height .25s ease, opacity .2s ease}
    .collapsible[hidden]{display:block;max-height:0 !important;padding-top:0 !important;margin-top:0 !important;opacity:0}
    .collapsible:not([hidden]){opacity:1}
    .toggle-rotate{transition:transform .2s ease}
    .is-collapsed .toggle-rotate{transform:rotate(180deg)}

    /* Confirmed style */
    .item.confirmed{border-color:var(--active);box-shadow:0 8px 20px rgba(241,90,41,.12)}
    .badge-confirm{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412}

    /* ★ 옵션2: 컬러 CSS별 + 애니메이션 */
    .confirm-btn{display:inline-flex;align-items:center;gap:6px;background:#fff;border:1px solid var(--line);color:#374151}
    .confirm-btn .star{font-size:15px;color:#d1d5db;transition:color .2s ease, transform .2s ease}
    .confirm-btn.on{background:#fff8e1;border-color:#fde68a;color:#92400e}
    .confirm-btn.on .star{color:#facc15;transform:scale(1.15) rotate(-10deg)}
    .confirm-btn[aria-pressed="true"]{background:#fff8e1;border-color:#fde68a;color:#92400e}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card p20 sticky" id="formCard" aria-live="polite">
      <div class="card-header">
        <h1>항목 업로드</h1>
        <button id="toggleForm" class="btn" aria-expanded="true" aria-controls="formBody" title="입력창 접기/펼치기">
          <span id="toggleText">입력창 접기</span>
          <span class="toggle-rotate" aria-hidden="true">▾</span>
        </button>
      </div>
      <div class="hr" style="height:1px;background:var(--line);margin:16px 0"></div>

      <div id="formBody" class="collapsible">
        <!-- 담당자 선택 -->
        <div class="section">
          <div class="muted" style="margin-bottom:6px">담당자</div>
          <div class="btn-group" role="group" aria-label="담당자" style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn person" data-value="김효주" aria-pressed="true">김효주</button>
            <button class="btn person" data-value="김영숙" aria-pressed="false">김영숙</button>
            <button class="btn person" data-value="권수경" aria-pressed="false">권수경</button>
          </div>
        </div>

        <!-- 성별 선택 -->
        <div class="section">
          <div class="muted" style="margin-bottom:6px">성별</div>
          <div class="btn-group" role="group" aria-label="성별" style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn gender" data-value="여" aria-pressed="true">여</button>
            <button class="btn gender" data-value="남" aria-pressed="false">남</button>
          </div>
        </div>

        <!-- 입력 칸 -->
        <div class="section grid">
          <div class="field"><label>이름</label><input id="name" placeholder="예: 김철수" autocomplete="name" /></div>
          <div class="field"><label>나이</label><input id="age" type="number" inputmode="numeric" placeholder="예: 28" min="0" max="120" /></div>
          <div class="field" style="grid-column:1/-1"><label>전화</label>
            <input id="phone" placeholder="000-0000-0000 / 0000-000-0000 / 0000-0000-0000" inputmode="tel" maxlength="19" />
          </div>
        </div>

        <div class="actions">
          <button id="submit" class="btn submit">등록</button>
          <button id="clear" class="btn">입력 초기화</button>
        </div>
      </div>
    </div>

    <div class="card p16" style="margin-top:12px">
      <div class="toolbar">
        <h2 style="margin:0;font-size:18px">목록</h2>
        <div class="btn-group" role="group" aria-label="보기 필터" style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn filter primary" data-filter="ALL">전체</button>
          <button class="btn filter" data-filter="김효주">김효주</button>
          <button class="btn filter" data-filter="김영숙">김영숙</button>
          <button class="btn filter" data-filter="권수경">권수경</button>
        </div>
      </div>
      <div id="list"></div>
    </div>
  </div>

  <script type="module">
    // ===== Firebase 사용 여부 =====
    const useFirebase = !!window.__USE_FIREBASE__ && typeof window.__firebaseInit === 'function';
    let fs = null;
    if (useFirebase){ fs = window.__firebaseInit(); }

    const STORAGE_KEY = 'entries.v1';
    const COLLAPSE_KEY = 'form.collapsed.v1';

    const $$ = (sel,ctx=document)=>Array.from(ctx.querySelectorAll(sel));
    const $ = (sel,ctx=document)=>ctx.querySelector(sel);

    // ===== ID 생성 =====
    function uid(){ return (Date.now().toString(36)+Math.random().toString(36).slice(2,8)); }

    // ===== 저장 =====
    async function saveEntry(data){
      const payload = { ...data, confirmed: false }; // 기본은 미확정
      if (useFirebase){
        const col = fs.collection(fs.db,'entries');
        const ref = await fs.addDoc(col, { ...payload, createdAt: fs.serverTimestamp() });
        return ref.id;
      } else {
        const list = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        const id = uid();
        list.push({ id, ...payload, createdAt: Date.now() });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
        return id;
      }
    }

    // ===== 부분 업데이트 =====
    async function updateEntry(id, partial){
      if (useFirebase){
        const col = fs.collection(fs.db,'entries');
        const docRef = fs.doc(col, id);
        await fs.updateDoc(docRef, partial);
      } else {
        const list = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        const idx = list.findIndex(x=>x.id===id);
        if (idx>-1){
          list[idx] = { ...list[idx], ...partial };
          localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
        }
      }
    }

    // ===== 불러오기 (+마이그레이션: id/confirmed 보장) =====
    async function loadEntries(){
      if (useFirebase){
        const col = fs.collection(fs.db,'entries');
        const q = fs.query(col, fs.orderBy('createdAt','desc'));
        const snap = await fs.getDocs(q);
        const rows = [];
        snap.forEach(doc=>{
          const d = doc.data();
          rows.push({
            id: doc.id,
            person:d.person, name:d.name, gender:d.gender,
            age:d.age ?? null, phone:d.phone ?? '',
            confirmed: !!d.confirmed,
            createdAt:d.createdAt?.toMillis?.() ?? Date.now()
          })
        });
        return rows;
      } else {
        let list = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        let changed = false;
        list = list.map((r)=>{
          if (!r.id){ r.id = uid(); changed = true; }
          if (typeof r.confirmed !== 'boolean'){ r.confirmed = false; changed = true; }
          return r;
        });
        if (changed) localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
        return list;
      }
    }

    // ===== 상태 & 헬퍼 =====
    let state = { person: '김효주', gender: '여', filter: 'ALL' };

    function bindSingleSelect(selector, stateKey){
      $$(selector).forEach(btn=>{
        btn.addEventListener('click', ()=>{
          $$(selector).forEach(b=>b.setAttribute('aria-pressed','false'));
          btn.setAttribute('aria-pressed','true');
          state[stateKey] = btn.dataset.value;
        })
      })
    }
    bindSingleSelect('.person','person');
    bindSingleSelect('.gender','gender');

    // 입력 초기화
    $('#clear')?.addEventListener('click', ()=>{
      $('#name').value='';
      $('#age').value='';
      $('#phone').value='';
    });

    // ===== 전화번호 입력 마스킹 (3-4-4 / 4-3-4 / 4-4-4 / 4-4-4-4 지원) =====
    $('#phone')?.addEventListener('input', (e)=>{
      const raw = e.target.value.replace(/[^0-9]/g,'').slice(0,16); // 최대 16자리
      const isMobile3 = raw.startsWith('010') || raw.startsWith('011') ||
                        raw.startsWith('016') || raw.startsWith('017') ||
                        raw.startsWith('018') || raw.startsWith('019');

      let v = raw;

      if (raw.length <= 3) {
        // 그대로
      } else if (raw.length <= 7) {
        // 3-? 또는 4-?
        if (isMobile3) {
          v = raw.slice(0,3) + '-' + raw.slice(3);
        } else {
          v = raw.slice(0,4) + '-' + raw.slice(4);
        }
      } else if (raw.length <= 11) {
        // 11자리: 휴대폰(3-4-4) 우선, 아니면 4-3-4
        if (isMobile3) {
          v = raw.slice(0,3) + '-' + raw.slice(3,7) + '-' + raw.slice(7);
        } else {
          v = raw.slice(0,4) + '-' + raw.slice(4,7) + '-' + raw.slice(7);
        }
      } else if (raw.length <= 12) {
        // 12자리: 4-4-4
        v = raw.slice(0,4) + '-' + raw.slice(4,8) + '-' + raw.slice(8);
      } else {
        // 13~16자리: 4-4-4-나머지 (최대 4)
        v = raw.slice(0,4) + '-' + raw.slice(4,8) + '-' + raw.slice(8,12) + '-' + raw.slice(12);
      }

      e.target.value = v;
    });

    // ===== 유효성 검사 =====
    function validate(){
      const name = $('#name').value.trim();
      const age = $('#age').value.trim();
      const phone = $('#phone').value.trim();
      const digitsOnly = phone.replace(/[^0-9]/g,'');

      if (!name) return [false,'이름을 입력해주세요'];
      if (age && (isNaN(Number(age)) || Number(age) < 0 || Number(age) > 120)) return [false,'나이를 0~120 사이 숫자로 입력'];

      // 허용: 3-4-4(11), 4-3-4(11), 4-4-4(12), 4-4-4-4(16)
      if (!(digitsOnly.length===11 || digitsOnly.length===12 || digitsOnly.length===16))
        return [false,'전화번호는 3-4-4 / 4-3-4 / 4-4-4 / 4-4-4-4 형식이어야 합니다'];

      if (!/^(\d{3}-\d{4}-\d{4}|\d{4}-\d{3}-\d{4}|\d{4}-\d{4}-\d{4}|\d{4}-\d{4}-\d{4}-\d{4})$/.test(phone))
        return [false,'전화번호는 3-4-4 / 4-3-4 / 4-4-4 / 4-4-4-4 형식이어야 합니다'];

      return [true,{ name, age: age?Number(age):null, phone }];
    }

    // 등록
    $('#submit')?.addEventListener('click', async ()=>{
      const [ok, data] = validate();
      if (!ok){ alert(data); return; }
      const payload = { person: state.person, gender: state.gender, ...data };
      try{
        await saveEntry(payload);
        alert('등록되었습니다!');
        $('#clear').click();
        await render();
      }catch(err){
        console.error(err);
        alert('저장 중 오류가 발생했습니다');
      }
    });

    // 필터 버튼
    $$('.filter').forEach(b=>b.addEventListener('click',()=>{
      $$('.filter').forEach(x=>x.classList.remove('primary'));
      b.classList.add('primary');
      state.filter = b.dataset.filter;
      render();
    }));

    // ====== 아이템 영역 이벤트 위임: 확정 토글 ======
    $('#list').addEventListener('click', async (e)=>{
      const btn = e.target.closest('.confirm-btn');
      if (!btn) return;
      const id = btn.dataset.id;
      const current = btn.getAttribute('aria-pressed') === 'true';
      try{
        await updateEntry(id, { confirmed: !current });
        await render();
      }catch(err){
        console.error(err);
        alert('상태 업데이트 중 오류가 발생했습니다');
      }
    });

    // ===== 렌더링 =====
    async function render(){
      const container = $('#list');
      container.innerHTML = '<div class="muted">불러오는 중...</div>';
      let rows = await loadEntries();
      rows.sort((a,b)=> a.name.localeCompare(b.name, 'ko'));
      if (state.filter !== 'ALL') rows = rows.filter(r=>r.person===state.filter);

      const groups = ['김효주','김영숙','권수경'];
      let html = '';

      if (state.filter === 'ALL') {
        // 전체 보기: 그룹 제목 없이 모두 출력
        const allItems = rows.map(r => itemHTML(r)).join('');
        html = allItems || '<div class="muted">등록된 항목이 없습니다.</div>';
      } else {
        // 특정 담당자 보기
        html = groups
          .filter(g => g === state.filter)
          .map(g=>{
            const items = rows.filter(r=>r.person===g);
            const listHtml = items.length===0 ? '<div class="muted">항목이 없습니다</div>' : items.map(r=> itemHTML(r)).join('');
            return `<div class="group"><h3>${g}</h3>${listHtml}</div>`
          }).join('');
      }

      container.innerHTML = html;
    }

    // 항목 카드 (확정 표시 포함, 옵션2 별 버튼)
    function itemHTML(r){
      const pressed = r.confirmed ? 'true' : 'false';
      const onClass = r.confirmed ? 'on' : '';
      return `<div class="item ${r.confirmed ? 'confirmed':''}">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <div style="font-weight:600">${r.name || '(이름없음)'}</div>
          <button class="btn iconbtn confirm-btn ${onClass}" data-id="${r.id}" aria-pressed="${pressed}" title="면접 확정 토글">
            <span class="star">★</span> 확정
          </button>
        </div>
        <div class="meta">
          <span class="chip">성별: ${r.gender}</span>
          ${r.age?`<span class="chip">나이: ${r.age}</span>`:""}
          <a class="chip" href="tel:${(r.phone || '').replace(/[^0-9]/g,'')}">전화: ${r.phone}</a>
          ${r.confirmed ? `<span class="chip badge-confirm">면접 확정</span>` : ''}
        </div>
      </div>`;
    }

    // ===== 입력창 접기/펼치기 =====
    const formBody = $('#formBody');
    const toggleBtn = $('#toggleForm');
    const toggleText = $('#toggleText');
    const formCard = $('#formCard');

    let collapsed = localStorage.getItem(COLLAPSE_KEY) === '1';
    applyCollapse(collapsed, false);

    toggleBtn.addEventListener('click', ()=>{
      collapsed = !collapsed;
      applyCollapse(collapsed, true);
      localStorage.setItem(COLLAPSE_KEY, collapsed ? '1' : '0');
    });

    function applyCollapse(isCollapsed, animate){
      toggleBtn.setAttribute('aria-expanded', String(!isCollapsed));
      toggleText.textContent = isCollapsed ? '입력창 펼치기' : '입력창 접기';
      formCard.classList.toggle('is-collapsed', isCollapsed);

      if (!animate){
        if (isCollapsed){
          formBody.setAttribute('hidden','');
          formBody.style.maxHeight = '0px';
        } else {
          formBody.removeAttribute('hidden');
          formBody.style.maxHeight = formBody.scrollHeight + 'px';
          requestAnimationFrame(()=>{ formBody.style.maxHeight = 'none'; });
        }
        return;
      }

      if (isCollapsed){
        formBody.style.maxHeight = formBody.scrollHeight + 'px';
        requestAnimationFrame(()=>{
          formBody.style.maxHeight = '0px';
          formBody.setAttribute('hidden','');
        });
      } else {
        formBody.removeAttribute('hidden');
        formBody.style.maxHeight = '0px';
        requestAnimationFrame(()=>{
          formBody.style.maxHeight = formBody.scrollHeight + 'px';
          formBody.addEventListener('transitionend', function handler(e){
            if (e.propertyName === 'max-height'){
              formBody.style.maxHeight = 'none';
              formBody.removeEventListener('transitionend', handler);
            }
          });
        });
      }
    }

    render();
  </script>

  <!-- ===== Firebase SDK + 초기화 ===== -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
  <script>
    // 공유 저장소 사용 ON
    window.__USE_FIREBASE__ = true;

    // 우리 코드가 기대하는 초기화 함수
    window.__firebaseInit = function(){
      const firebaseConfig = {
        apiKey: "AIzaSyAm76AFTjWcxzeENXeMqDfKygkrESNoFkM",
        authDomain: "sfp-upload.firebaseapp.com",
        projectId: "sfp-upload"
      };
      const app = firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      return {
        db,
        collection: (db, name) => db.collection(name),
        addDoc: (col, data) => col.add(data),
        getDocs: (q) => q.get(),
        serverTimestamp: () => firebase.firestore.FieldValue.serverTimestamp(),
        orderBy: (field, dir) => ({ field, dir }),
        query: (col, ord) => col.orderBy(ord.field, ord.dir),
        // 업데이트용
        doc: (col, id) => col.doc(id),
        updateDoc: (docRef, data) => docRef.update(data),
      };
    };
  </script>
</body>
</html>
