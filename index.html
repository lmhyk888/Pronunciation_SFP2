<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>업로드 폼</title>
  <style>
    :root{--bg:#ffffff;--card:#f9fafb;--muted:#6b7280;--text:#111827;--accent:#22c55e;--accent2:#3b82f6;--danger:#ef4444;--chip:#e5e7eb;--active:#f15a29}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:900px;margin:0 auto;padding:20px}
    .card{background:var(--card);border:1px solid #d1d5db;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
    .p16{padding:16px} .p20{padding:20px}
    h1{font-size:22px;margin:0 0 12px}
    .muted{color:var(--muted);font-size:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid #d1d5db;background:white;color:var(--text);padding:10px 14px;border-radius:999px;cursor:pointer;font-size:16px}
    .btn[aria-pressed="true"], .btn.primary{background:var(--active);border-color:transparent;color:white}
    .btn:active{transform:scale(.98)}
    .btn-group{display:flex;gap:8px;flex-wrap:wrap}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:720px){.grid{grid-template-columns:repeat(2,1fr)}}
    .field{display:flex;align-items:center;background:white;border:1px solid #d1d5db;border-radius:14px;padding:10px 12px}
    .field label{min-width:64px;color:var(--muted);font-size:14px}
    .field input, .field select{flex:1;background:transparent;border:0;outline:0;color:var(--text);font-size:16px}
    .section{margin-top:14px}
    .actions{display:flex;gap:10px;margin-top:12px}
    .submit{background:var(--accent);border:0;color:white}
    .reset{background:white;border:1px solid #d1d5db}
    .hr{height:1px;background:#e5e7eb;margin:16px 0}
    .group{margin-top:18px}
    .group h3{margin:0 0 8px;font-size:18px;color:#1f2937}
    .item{display:flex;flex-direction:column;gap:6px;background:white;border:1px solid #d1d5db;border-radius:14px;padding:12px;margin-bottom:8px}
    .chip{display:inline-flex;align-items:center;gap:6px;background:#f3f4f6;border:1px dashed #d1d5db;color:#374151;border-radius:999px;padding:6px 10px;font-size:12px}
    .meta{display:flex;flex-wrap:wrap;gap:6px}
    .time{color:var(--muted);font-size:12px}
    .empty{color:var(--muted);font-size:14px;}
    .sticky{position:sticky;top:0;z-index:10;background:var(--bg)}
    .toolbar{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card p20 sticky">
      <h1>항목 업로드</h1>
      <div class="hr"></div>

      <!-- 선택: 효주/영숙/수경 (필수, 버튼식) -->
      <div class="section">
        <div class="muted" style="margin-bottom:6px">담당자</div>
        <div class="btn-group" role="group" aria-label="담당자">
          <button class="btn person" data-value="효주" aria-pressed="true">효주</button>
          <button class="btn person" data-value="영숙" aria-pressed="false">영숙</button>
          <button class="btn person" data-value="수경" aria-pressed="false">수경</button>
        </div>
      </div>

      <!-- 성별: 남/여 (버튼식) -->
      <div class="section">
        <div class="muted" style="margin-bottom:6px">성별</div>
        <div class="btn-group" role="group" aria-label="성별">
          <button class="btn gender" data-value="여" aria-pressed="true">여</button>
          <button class="btn gender" data-value="남" aria-pressed="false">남</button>
        </div>
      </div>

      <!-- 입력 칸: 이름, 나이, 전화번호 -->
      <div class="section grid">
        <div class="field"><label>이름</label><input id="name" placeholder="예: 김철수" autocomplete="name" /></div>
        <div class="field"><label>나이</label><input id="age" type="number" inputmode="numeric" placeholder="예: 28" min="0" max="120" /></div>
        <div class="field" style="grid-column:1/-1"><label>전화</label><input id="phone" placeholder="0000-1111-2222" inputmode="tel" maxlength="19" /></div>
      </div>

      <div class="actions">
        <button id="submit" class="btn submit">등록</button>
        <button id="clear" class="btn reset">입력 초기화</button>
      </div>
    </div>

    <div class="card p16" style="margin-top:12px">
      <div class="toolbar">
        <h2 style="margin:0;font-size:18px">목록</h2>
        <div class="btn-group" role="group" aria-label="보기 필터">
          <button class="btn filter primary" data-filter="ALL">전체</button>
          <button class="btn filter" data-filter="효주">효주</button>
          <button class="btn filter" data-filter="영숙">영숙</button>
          <button class="btn filter" data-filter="수경">수경</button>
        </div>
      </div>
      <div id="list"></div>
    </div>
  </div>

  <script type="module">
    // ===== 저장소 레이어 (Firestore 없으면 localStorage) =====
    const useFirebase = !!window.__USE_FIREBASE__ && typeof window.__firebaseInit === 'function';
    let fs = null;
    if (useFirebase){ fs = window.__firebaseInit(); }

    const STORAGE_KEY = 'entries.v1';

    async function saveEntry(data){
      if (useFirebase){
        const col = fs.collection(fs.db,'entries');
        await fs.addDoc(col, { ...data, createdAt: fs.serverTimestamp() });
        return true;
      } else {
        const list = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        list.push({ ...data, createdAt: Date.now() });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
        return true;
      }
    }

    async function loadEntries(){
      if (useFirebase){
        const col = fs.collection(fs.db,'entries');
        const q = fs.query(col, fs.orderBy('createdAt','desc'));
        const snap = await fs.getDocs(q);
        const rows = [];
        snap.forEach(doc=>{
          const d = doc.data();
          rows.push({
            person: d.person,
            name: d.name,
            gender: d.gender,
            age: d.age,
            phone: d.phone,
            createdAt: d.createdAt?.toMillis?.() ?? Date.now()
          })
        });
        return rows;
      } else {
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      }
    }

    // ===== UI 상태 =====
    let state = { person: '효주', gender: '여', filter: 'ALL' };
    const $$ = (sel,ctx=document)=>Array.from(ctx.querySelectorAll(sel));
    const $ = (sel,ctx=document)=>ctx.querySelector(sel);

    function bindSingleSelect(selector, stateKey){
      $$(selector).forEach(btn=>{
        btn.addEventListener('click', ()=>{
          $$(selector).forEach(b=>b.setAttribute('aria-pressed','false'));
          btn.setAttribute('aria-pressed','true');
          state[stateKey] = btn.dataset.value;
        })
      })
    }
    bindSingleSelect('.person','person');
    bindSingleSelect('.gender','gender');

    // ===== 입력 초기화 =====
    $('#clear').addEventListener('click', ()=>{
      $('#name').value='';
      $('#age').value='';
      $('#phone').value='';
    });

    // ===== 전화번호 입력: 숫자만, 최대 16자리, 4-4-4(-4)로 자동 하이픈 =====
    $('#phone').addEventListener('input', (e)=>{
      const digits = e.target.value.replace(/[^0-9]/g,'').slice(0,16); // 숫자 최대 16자
      const parts = digits.match(/\d{1,4}/g) || []; // 1~4자리씩 분할
      e.target.value = parts.join('-'); // 4자리 단위로 하이픈 연결
    });

    // ===== 유효성 검사 =====
    function validate(){
      const name = $('#name').value.trim();
      const age = $('#age').value.trim();
      const phone = $('#phone').value.trim();
      const digitsOnly = phone.replace(/[^0-9]/g,'');

      if (!name) return [false,'이름을 입력해주세요'];
      if (age && (isNaN(Number(age)) || Number(age) < 0 || Number(age) > 120)) return [false,'나이를 0~120 사이 숫자로 입력'];

      // 4자리 단위 하이픈: 12자리(4-4-4) 또는 16자리(4-4-4-4)만 통과
      if (!(digitsOnly.length === 12 || digitsOnly.length === 16)){
        return [false,'전화번호는 12자리(0000-1111-2222) 또는 16자리(0000-1111-2222-3333) 형식이어야 합니다'];
      }
      if (!/^\d{4}(-\d{4}){2,3}$/.test(phone)){
        return [false,'전화번호는 4자리-4자리-4자리(-4자리) 형식이어야 합니다'];
      }

      return [true,{ name, age: age?Number(age):null, phone }];
    }

    // ===== 등록 =====
    $('#submit').addEventListener('click', async ()=>{
      const [ok, data] = validate();
      if (!ok){ alert(data); return; }
      const payload = { person: state.person, gender: state.gender, ...data };
      try{
        await saveEntry(payload);
        alert('등록되었습니다!');
        $('#clear').click();
        await render();
      }catch(err){
        console.error(err);
        alert('저장 중 오류가 발생했습니다');
      }
    });

    // ===== 필터 버튼 (목록 카드 내부) =====
    $$('.filter').forEach(b=>b.addEventListener('click',()=>{
      $$('.filter').forEach(x=>x.classList.remove('primary'));
      b.classList.add('primary');
      state.filter = b.dataset.filter;
      render();
    }));

    // ===== 렌더링 =====
    async function render(){
      const container = $('#list');
      container.innerHTML = '<div class="muted">불러오는 중...</div>';
      let rows = await loadEntries();
      rows.sort((a,b)=> b.createdAt - a.createdAt); // 최신순 고정
      if (state.filter !== 'ALL') rows = rows.filter(r=>r.person===state.filter);

      const groups = ['효주','영숙','수경'];
      const html = groups
        .filter(g=> state.filter==='ALL' ? true : g===state.filter)
        .map(g=>{
          const items = rows.filter(r=>r.person===g);
          const listHtml = items.length===0
            ? '<div class="empty">항목이 없습니다</div>'
            : items.map(r=> itemHTML(r)).join('');
          return `<div class="group"><h3>${g}</h3>${listHtml}</div>`
        }).join('');
      container.innerHTML = html || '<div class="empty">등록된 항목이 없습니다.</div>';
    }

    function itemHTML(r){
      const time = new Date(r.createdAt);
      const ts = `${time.getFullYear()}-${String(time.getMonth()+1).padStart(2,'0')}-${String(time.getDate()).padStart(2,'0')} ${String(time.getHours()).padStart(2,'0')}:${String(time.getMinutes()).padStart(2,'0')}`;
      const telDigits = (r.phone || '').replace(/[^0-9]/g,'');
      return `<div class="item">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <div style="font-weight:600">${r.name || '(이름없음)'}</div>
          <div class="time">${ts}</div>
        </div>
        <div class="meta">
          <span class="chip">담당: ${r.person}</span>
          <span class="chip">성별: ${r.gender}</span>
          ${r.age?`<span class=\"chip\">나이: ${r.age}</span>`:""}
          <a class="chip" href="tel:${telDigits}">전화: ${r.phone}</a>
        </div>
      </div>`
    }

    // 초기 렌더
    render();
  </script>
</body>
</html>
